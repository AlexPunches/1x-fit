name: Deploy Bot and PostgreSQL

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      image_tag:
        description: 'Docker image tag to deploy (e.g., latest, main, sha-xxx)'
        required: false
        default: 'latest'
        type: string
      postgres_image_tag:
        description: 'PostgreSQL Docker image tag to deploy (e.g., latest, main, sha-xxx)'
        required: false
        default: 'latest'
        type: string
      force_recreate:
        description: 'Force recreate containers'
        required: false
        default: true
        type: boolean

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit
  POSTGRES_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit-postgres

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare bot deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Создание директории, если не существует
          sudo mkdir -p /opt/1x-fit/

          # Проверка наличия volume для данных
          docker volume inspect bot-db-data >/dev/null 2>&1 || docker volume create bot-db-data
          docker volume inspect bot-charts-data >/dev/null 2>&1 || docker volume create bot-charts-data

          # Определение тега образа для деплоя
          IMAGE_TAG="${{ inputs.image_tag }}"
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="latest"
          fi

          # Обновление образа бота
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit:$IMAGE_TAG

          # Остановка и удаление старого контейнера бота
          docker stop 1x-fit-bot || true
          
          if [ "${{ inputs.force_recreate }}" = "true" ]; then
            docker rm 1x-fit-bot || true
          fi

    - name: Prepare PostgreSQL deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Проверка наличия volume для PostgreSQL
          docker volume inspect anal_postgres-data >/dev/null 2>&1 || docker volume create anal_postgres-data

          # Определение тега образа PostgreSQL для деплоя
          POSTGRES_IMAGE_TAG="${{ inputs.postgres_image_tag }}"
          if [ -z "$POSTGRES_IMAGE_TAG" ]; then
            POSTGRES_IMAGE_TAG="latest"
          fi

          # Обновление образа PostgreSQL
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit-postgres:$POSTGRES_IMAGE_TAG

          # Остановка и удаление старого контейнера PostgreSQL
          docker stop 1x-fit-postgres || true
          
          if [ "${{ inputs.force_recreate }}" = "true" ]; then
            docker rm 1x-fit-postgres || true
          fi

    - name: Deploy PostgreSQL
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Запуск PostgreSQL контейнера
          docker run -d \
            --name 1x-fit-postgres \
            --env POSTGRES_PASSWORD=${{ secrets.ANAL_POSTGRES_PASSWORD }} \
            --env POSTGRES_USER=${{ secrets.ANAL_POSTGRES_USER }} \
            --env POSTGRES_DB=${{ secrets.ANAL_POSTGRES_DB }} \
            --volume anal_postgres-data:/var/lib/postgresql/data \
            -p 50432:50432 \
            --restart unless-stopped \
            ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit-postgres:$POSTGRES_IMAGE_TAG

    - name: Connect PostgreSQL to datalens network
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Проверяем, существует ли сеть datalens_default
          if docker network ls --format "{{.Name}}" | grep -q "^datalens_default$"; then
            echo "Сеть datalens_default существует. Подключаю 1x-fit-postgres..."
            docker network connect datalens_default 1x-fit-postgres
          else
            echo "Ошибка: сеть datalens_default не найдена. Убедитесь, что datalens запущен."
            exit 1
          fi

    - name: Deploy Bot
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Запуск основного контейнера бота
          docker run -d \
            --name 1x-fit-bot \
            --network datalens_default \
            --env BOT_TOKEN=${{ secrets.BOT_TOKEN }} \
            --env ADMIN_ID=${{ secrets.ADMIN_ID }} \
            --env WEBHOOK_URL=${{ secrets.WEBHOOK_URL }} \
            --env HOST=${{ secrets.HOST }} \
            --env PORT=${{ secrets.PORT }} \
            --env WEIGHT_NOTIFICATION_TIME=${{ secrets.WEIGHT_NOTIFICATION_TIME }} \
            --env ACTIVITY_NOTIFICATION_TIME=${{ secrets.ACTIVITY_NOTIFICATION_TIME }} \
            --env DATABASE_PATH=${{ secrets.DATABASE_PATH }} \
            --env CHARTS_DIR=${{ secrets.CHARTS_DIR }} \
            --env APP_ENV=${{ secrets.APP_ENV }} \
            --env LOG_MIN_LEVEL=${{ secrets.LOG_MIN_LEVEL }} \
            --env ANAL_POSTGRES_DB=${{ secrets.ANAL_POSTGRES_DB }} \
            --env ANAL_POSTGRES_USER=${{ secrets.ANAL_POSTGRES_USER }} \
            --env ANAL_POSTGRES_PASSWORD=${{ secrets.ANAL_POSTGRES_PASSWORD }} \
            -p 8000:8000 \
            --volume bot-db-data:/app/data \
            --volume bot-charts-data:/app/charts \
            --restart unless-stopped \
            ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit:$IMAGE_TAG

    - name: Check deployment status
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Проверка статуса контейнеров
          sleep 10
          BOT_CONTAINER_STATUS=$(docker ps --filter "name=1x-fit-bot" --format "{{.Status}}")
          POSTGRES_CONTAINER_STATUS=$(docker ps --filter "name=1x-fit-postgres" --format "{{.Status}}")
          echo "Bot container status: $BOT_CONTAINER_STATUS"
          echo "PostgreSQL container status: $POSTGRES_CONTAINER_STATUS"

          # Вывод логов контейнеров для диагностики
          echo "Last 10 lines of bot container logs:"
          docker logs 1x-fit-bot --tail 10
          echo "Last 10 lines of PostgreSQL container logs:"
          docker logs 1x-fit-postgres --tail 10