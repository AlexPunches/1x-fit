name: Deploy Bot, PostgreSQL, ETL

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
      bot_image_tag:
        description: 'Bot image tag (e.g., latest, sha-xxx)'
        required: false
        default: 'latest'
        type: string
      postgres_image_tag:
        description: 'PostgreSQL image tag (e.g., latest, sha-xxx)'
        required: false
        default: 'latest'
        type: string
      etl_image_tag:
        description: 'ETL image tag (e.g., latest, sha-xxx)'
        required: false
        default: 'latest'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare bot deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Создание директории, если не существует
          sudo mkdir -p /opt/1x-fit/

          # Проверка наличия volume для данных
          docker volume inspect bot-db-data >/dev/null 2>&1 || docker volume create bot-db-data
          docker volume inspect bot-charts-data >/dev/null 2>&1 || docker volume create bot-charts-data

          # Обновление образа бота
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit:${{ inputs.bot_image_tag }}

          # Остановка и удаление старого контейнера бота
          docker stop 1x-fit-bot || true
          
          docker rm 1x-fit-bot || true

    - name: Prepare PostgreSQL deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Проверка наличия volume для PostgreSQL
          docker volume inspect anal_postgres-data >/dev/null 2>&1 || docker volume create anal_postgres-data

          # Обновление образа PostgreSQL
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit-postgres:${{ inputs.postgres_image_tag }}

          # Остановка и удаление старого контейнера PostgreSQL
          docker stop 1x-fit-postgres || true
          
          docker rm 1x-fit-postgres || true

    - name: Prepare ETL deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Создание директории, если не существует
          sudo mkdir -p /opt/1x-fit-etl/

          # Проверка наличия volume для данных
          docker volume inspect bot-db-data >/dev/null 2>&1 || docker volume create bot-db-data

          # Обновление образа ETL
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit-etl:${{ inputs.bot_image_tag }}

          # Остановка и удаление старого контейнера ETL
          docker stop 1x-fit-etl || true
          
          docker rm 1x-fit-etl || true

    - name: Create application network
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Создаем сеть только если её нет
          if ! docker network inspect 1xfit_net >/dev/null 2>&1; then
            echo "Creating Docker network '1xfit_net'..."
            docker network create 1xfit_net
          else
            echo "Network '1xfit_net' already exists"
          fi

    - name: Deploy Bot
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Запуск основного контейнера бота
          docker run -d \
            --name 1x-fit-bot \
            --network 1xfit_net \
            --env BOT_TOKEN=${{ secrets.BOT_TOKEN }} \
            --env ADMIN_ID=${{ secrets.ADMIN_ID }} \
            --env WEBHOOK_URL=${{ vars.WEBHOOK_URL }} \
            --env HOST=${{ vars.HOST }} \
            --env PORT=${{ vars.PORT }} \
            --env WEIGHT_NOTIFICATION_TIME=${{ vars.WEIGHT_NOTIFICATION_TIME }} \
            --env ACTIVITY_NOTIFICATION_TIME=${{ vars.ACTIVITY_NOTIFICATION_TIME }} \
            --env DATABASE_PATH=${{ vars.DATABASE_PATH }} \
            --env CHARTS_DIR=${{ vars.CHARTS_DIR }} \
            --env APP_ENV=${{ vars.APP_ENV }} \
            --env LOG_MIN_LEVEL=${{ vars.LOG_MIN_LEVEL }} \
            --env ANAL_POSTGRES_DB=${{ secrets.ANAL_POSTGRES_DB }} \
            --env ANAL_POSTGRES_USER=${{ secrets.ANAL_POSTGRES_USER }} \
            --env ANAL_POSTGRES_PASSWORD=${{ secrets.ANAL_POSTGRES_PASSWORD }} \
            --env ANAL_POSTGRES_PORT=${{ vars.INTERNAL_ANAL_POSTGRES_PORT }} \
            --env ANAL_POSTGRES_HOST=${{ vars.ANAL_POSTGRES_HOST }} \
            -p 8000:8000 \
            --volume bot-db-data:/app/data \
            --volume bot-charts-data:/app/charts \
            --restart unless-stopped \
            ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit:${{ inputs.bot_image_tag }}

    - name: Deploy PostgreSQL
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Запуск PostgreSQL контейнера
          docker run -d \
            --name 1x-fit-postgres \
            --network 1xfit_net \
            --env POSTGRES_PASSWORD=${{ secrets.ANAL_POSTGRES_PASSWORD }} \
            --env POSTGRES_USER=${{ secrets.ANAL_POSTGRES_USER }} \
            --env POSTGRES_DB=${{ secrets.ANAL_POSTGRES_DB }} \
            --volume anal_postgres-data:/var/lib/postgresql/data \
            -p ${{ vars.EXTERNAL_ANAL_POSTGRES_PORT }}:${{ vars.INTERNAL_ANAL_POSTGRES_PORT }} \
            --restart unless-stopped \
            ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit-postgres:${{ inputs.postgres_image_tag }}

    - name: Deploy ETL
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Запуск ETL контейнера
          docker run -d \
            --name 1x-fit-etl \
            --network 1xfit_net \
            --env ETL_INTERVAL_MINUTES=${{ vars.ETL_INTERVAL_MINUTES }} \
            --env ETL_ANAL_POSTGRES_DB=${{ secrets.ANAL_POSTGRES_DB }} \
            --env ETL_ANAL_POSTGRES_USER=${{ secrets.ANAL_POSTGRES_USER }} \
            --env ETL_ANAL_POSTGRES_PASSWORD=${{ secrets.ANAL_POSTGRES_PASSWORD }} \
            --env ETL_ANAL_POSTGRES_PORT=${{ vars.INTERNAL_ANAL_POSTGRES_PORT }} \
            --env ETL_ANAL_POSTGRES_HOST=${{ vars.ANAL_POSTGRES_HOST }} \
            --volume bot-db-data:/app/data \
            --restart unless-stopped \
            ${{ secrets.DOCKERHUB_USERNAME }}/1x-fit-etl:${{ inputs.etl_image_tag }}

    - name: Check deployment status
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Проверка статуса контейнеров
          sleep 10
          BOT_CONTAINER_STATUS=$(docker ps --filter "name=1x-fit-bot" --format "{{.Status}}")
          POSTGRES_CONTAINER_STATUS=$(docker ps --filter "name=1x-fit-postgres" --format "{{.Status}}")
          echo "Bot container status: $BOT_CONTAINER_STATUS"
          echo "PostgreSQL container status: $POSTGRES_CONTAINER_STATUS"

          # Вывод логов контейнеров для диагностики
          echo "Last 10 lines of bot container logs:"
          docker logs 1x-fit-bot --tail 10
          echo "Last 10 lines of PostgreSQL container logs:"
          docker logs 1x-fit-postgres --tail 10