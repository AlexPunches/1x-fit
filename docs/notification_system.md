# Система уведомлений и опросов участников

## Общее описание

Система уведомлений и опросов обеспечивает регулярное взаимодействие с участниками соревнования, собирая данные о весе и количестве шагов в установленное время. Также предусматривается возможность расширения системы для добавления дополнительных опросов.

## Расписание опросов

### Ежедневные опросы

1. **Запрос веса** - 10:00 по местному времени участника
   - Сообщение: "Привет! Пожалуйста, введи свой сегодняшний вес в килограммах."
   - Клавиатура: числовая клавиатура для быстрого ввода

2. **Запрос количества шагов** - 22:00 по местному времени участника
   - Сообщение: "Какое количество шагов ты сделал сегодня?"
   - Клавиатура: числовая клавиатура для быстрого ввода

## Техническая реализация

### Используемые компоненты

1. **aiogram scheduler** - для планирования задач
2. **datetime** - для работы с временными метками
3. **pytz** - для работы с часовыми поясами (если потребуется)
4. **Python 3.13** - основной язык программирования с современными возможностями асинхронности

### Структура опроса

Каждый опрос будет представлен в виде объекта с атрибутами:

```python
class Poll:
    def __init__(self, time, message, data_type, timezone='UTC'):
        self.time = time  # Время в формате HH:MM
        self.message = message  # Текст сообщения
        self.data_type = data_type  # 'weight', 'steps' или другие типы
        self.timezone = timezone  # Часовой пояс
```

### Хранение расписания

Расписание будет храниться в конфигурационном файле или в базе данных, чтобы можно было легко добавлять новые опросы без изменения кода:

```yaml
polls:
  - time: "10:00"
    message: "Привет! Пожалуйста, введи свой сегодняшний вес в килограммах."
    data_type: "weight"
  - time: "22:00"
    message: "Какое количество шагов ты сделал сегодня?"
    data_type: "steps"
  - time: "20:00"
    message: "Какую физическую активность ты выполнял сегодня?"
    data_type: "activity"
```

## Обработка ответов

### Валидация данных

- Проверка, что введенное значение является числом
- Проверка, что вес находится в разумном диапазоне (например, 30-300 кг)
- Проверка, что количество шагов находится в разумном диапазоне (например, 0-50000)

### Сохранение данных

- После получения корректного ответа, данные сохраняются в соответствующую таблицу базы данных
- Для веса: в таблицу `weight_records`
- Для шагов: в таблицу `step_records`

### Обработка некорректных ответов

- При получении некорректного ответа, бот отправляет сообщение с просьбой повторить ввод
- После нескольких неудачных попыток, бот может отправить дополнительные инструкции

## Система напоминаний

### Механизм напоминаний

Если участник не ответил на опрос в течение заданного времени (например, 2 часа после отправки), система отправляет напоминание:

- Первое напоминание: через 1 час после опроса
- Второе напоминание: через 2 часа после опроса
- Отметка о пропущенном опросе: если нет ответа через 3 часа

### Настройка напоминаний

Напоминания могут быть настроены индивидуально для каждого участника:
- Участник может отключить напоминания
- Участник может изменить время напоминаний
- Участник может установить максимальное количество напоминаний

## Расширяемость системы

### Добавление новых опросов

Для добавления новых опросов необходимо:

1. Определить новый тип данных в системе
2. Добавить новую запись в конфигурационный файл
3. Обновить обработчики сообщений для нового типа данных
4. При необходимости, добавить новую таблицу в базу данных

### Условные опросы

Система может поддерживать условные опросы, которые отправляются только при определенных условиях:

- Если участник сбросил более 5 кг за последние 2 недели, отправить дополнительный опрос о самочувствии
- Если участник достиг цели, отправить поздравительное сообщение
- Если участник не отвечал на опросы более 3 дней подряд, отправить мотивационное сообщение

## Обработка ошибок

### Технические ошибки

- Если бот не может отправить сообщение (например, пользователь заблокировал бота), записать ошибку в лог
- Не пытаться отправлять сообщения заблокированным пользователям

### Логирование

- Все отправленные опросы должны быть зафиксированы в логе
- Все полученные ответы должны быть зафиксированы в логе
- Все ошибки должны быть зафиксированы в логе

## Управление системой

### Административные команды

- `/pause_polls` - приостановить отправку опросов (например, во время праздников)
- `/resume_polls` - возобновить отправку опросов
- `/add_poll` - добавить новый опрос (для администраторов)
- `/remove_poll` - удалить опрос (для администраторов)

### Мониторинг

- Отслеживание процента участников, ответивших на опросы
- Отслеживание среднего времени ответа
- Отслеживание количества пропущенных опросов